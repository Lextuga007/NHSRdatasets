<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LOS_model: A simulated hospital length-of-stay dataset • NHSRdatasets</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="LOS_model: A simulated hospital length-of-stay dataset">
<meta property="og:description" content="">
<meta property="og:image" content="https://nhs-r-community.github.io/NHSRdatasets/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-146859070-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-146859070-2');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">NHSRdatasets</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/LOS_model.html">LOS_model: A simulated hospital length-of-stay dataset</a>
    </li>
    <li>
      <a href="../articles/ae_attendances.html">ae_attendances dataset</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/nhs-r-community/NHSRdatasets">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>LOS_model: A simulated hospital length-of-stay dataset</h1>
                        <h4 class="author">Chris Mainey</h4>
            
            <h4 class="date">2019-10-14</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/nhs-r-community/NHSRdatasets/blob/master/vignettes/LOS_model.Rmd"><code>vignettes/LOS_model.Rmd</code></a></small>
      <div class="hidden name"><code>LOS_model.Rmd</code></div>

    </div>

    
    
<p>This vignette details why the <code>LOS_model</code> dataset was created, how to load it, and gives examples of use for learning/teaching regression modelling using Generalized Linear Models (GLMs), and related techniques.</p>
<p>The data were created specifically for regression tutorials, simulating a small set of data on hospital in-patient spells. The data are 10 sets of 30 simulated patient records, representing 10 different hospitals (“Trusts”). The dataset contains:</p>
<ul>
<li>
<strong>ID:</strong> an integer value patient number</li>
<li>
<strong>Organisation:</strong> A factor, containing hospital name, e.g. “Trust1”</li>
<li>
<strong>Age:</strong> an integer representing patient age in years</li>
<li>
<strong>LOS:</strong> ‘Length of Stay,’ an integer representing the number of days a patient was in hospital</li>
<li>
<strong>Death:</strong> an integer flag (0 or 1) representing whether a patient died</li>
</ul>
<div id="first-load-the-data-and-inspect-it" class="section level2">
<h2 class="hasAnchor">
<a href="#first-load-the-data-and-inspect-it" class="anchor"></a>First, load the data and inspect it</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(NHSRdatasets)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(dplyr)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ggplot2)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"LOS_model"</span>)</a>
<a class="sourceLine" id="cb1-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(LOS_model)</a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="co">#&gt;   ID Organisation Age LOS Death</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="co">#&gt; 1  1       Trust1  55   2     0</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="co">#&gt; 2  2       Trust2  27   1     0</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11"><span class="co">#&gt; 3  3       Trust3  93  12     0</span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12"><span class="co">#&gt; 4  4       Trust4  45   3     1</span></a>
<a class="sourceLine" id="cb1-13" data-line-number="13"><span class="co">#&gt; 5  5       Trust5  70  11     0</span></a>
<a class="sourceLine" id="cb1-14" data-line-number="14"><span class="co">#&gt; 6  6       Trust6  60   7     0</span></a>
<a class="sourceLine" id="cb1-15" data-line-number="15"></a>
<a class="sourceLine" id="cb1-16" data-line-number="16"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(LOS_model)</a>
<a class="sourceLine" id="cb1-17" data-line-number="17"><span class="co">#&gt;        ID          Organisation      Age             LOS        </span></a>
<a class="sourceLine" id="cb1-18" data-line-number="18"><span class="co">#&gt;  Min.   :  1.00   Trust1 : 30   Min.   : 5.00   Min.   : 1.000  </span></a>
<a class="sourceLine" id="cb1-19" data-line-number="19"><span class="co">#&gt;  1st Qu.: 75.75   Trust2 : 30   1st Qu.:24.00   1st Qu.: 2.000  </span></a>
<a class="sourceLine" id="cb1-20" data-line-number="20"><span class="co">#&gt;  Median :150.50   Trust3 : 30   Median :54.00   Median : 4.000  </span></a>
<a class="sourceLine" id="cb1-21" data-line-number="21"><span class="co">#&gt;  Mean   :150.50   Trust4 : 30   Mean   :50.66   Mean   : 4.937  </span></a>
<a class="sourceLine" id="cb1-22" data-line-number="22"><span class="co">#&gt;  3rd Qu.:225.25   Trust5 : 30   3rd Qu.:75.25   3rd Qu.: 7.000  </span></a>
<a class="sourceLine" id="cb1-23" data-line-number="23"><span class="co">#&gt;  Max.   :300.00   Trust6 : 30   Max.   :95.00   Max.   :18.000  </span></a>
<a class="sourceLine" id="cb1-24" data-line-number="24"><span class="co">#&gt;                   (Other):120                                   </span></a>
<a class="sourceLine" id="cb1-25" data-line-number="25"><span class="co">#&gt;      Death       </span></a>
<a class="sourceLine" id="cb1-26" data-line-number="26"><span class="co">#&gt;  Min.   :0.0000  </span></a>
<a class="sourceLine" id="cb1-27" data-line-number="27"><span class="co">#&gt;  1st Qu.:0.0000  </span></a>
<a class="sourceLine" id="cb1-28" data-line-number="28"><span class="co">#&gt;  Median :0.0000  </span></a>
<a class="sourceLine" id="cb1-29" data-line-number="29"><span class="co">#&gt;  Mean   :0.1767  </span></a>
<a class="sourceLine" id="cb1-30" data-line-number="30"><span class="co">#&gt;  3rd Qu.:0.0000  </span></a>
<a class="sourceLine" id="cb1-31" data-line-number="31"><span class="co">#&gt;  Max.   :1.0000  </span></a>
<a class="sourceLine" id="cb1-32" data-line-number="32"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb1-33" data-line-number="33"></a>
<a class="sourceLine" id="cb1-34" data-line-number="34"><span class="co"># 82.3% survived</span></a>
<a class="sourceLine" id="cb1-35" data-line-number="35"><span class="kw"><a href="https://rdrr.io/r/base/prop.table.html">prop.table</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/table.html">table</a></span>(LOS_model<span class="op">$</span>Death))</a>
<a class="sourceLine" id="cb1-36" data-line-number="36"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb1-37" data-line-number="37"><span class="co">#&gt;         0         1 </span></a>
<a class="sourceLine" id="cb1-38" data-line-number="38"><span class="co">#&gt; 0.8233333 0.1766667</span></a></code></pre></div>
<p>Now lets look at the distributions of Age and LOS. We might expect Age to be normally distributed, but this would be unrealistic, as elderly patient represent higher proportions of the total in-patients. It could be uniform, it could be bi-modal (or have more peaks), but nothing is particularly clear. LOS is highly right-skewed. This means that the high values will affect the mean, dragging it out, and the median would be a better estimation of the centre of the distribution. This shows that most patients don’t stay very long, but a few patients stay notably longer.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(LOS_model, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x=</span>Age)) <span class="op">+</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span>(<span class="dt">alpha=</span><span class="fl">0.5</span>, <span class="dt">col=</span><span class="dv">1</span>, <span class="dt">fill=</span><span class="dv">12</span>, <span class="dt">bins=</span><span class="dv">20</span>)<span class="op">+</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Distribution of Age"</span>)</a></code></pre></div>
<p><img src="LOS_model_files/figure-html/VisageLOS-1.png" width="700"></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(LOS_model, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x=</span>LOS)) <span class="op">+</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span>(<span class="dt">alpha=</span><span class="fl">0.5</span>, <span class="dt">col=</span><span class="dv">1</span>, <span class="dt">fill=</span><span class="dv">13</span>, <span class="dt">bins=</span><span class="dv">20</span>)<span class="op">+</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Distribution of Length-of-Stay"</span>)</a></code></pre></div>
<p><img src="LOS_model_files/figure-html/VisageLOS-2.png" width="700"></p>
</div>
<div id="modelling-los-and-death" class="section level2">
<h2 class="hasAnchor">
<a href="#modelling-los-and-death" class="anchor"></a>Modelling LOS and Death</h2>
<p>We will attempt to model LOS, using Age and Death, and also to model Death using LOS and Age. This vignette does not describe linear models per se, but assumes you are familiar with linear regression. If not, pause here and do a little reading before you continue.</p>
<p>Our data are not continuous, linear, or normally distributed. Death is binary, LOS is a count. We can extend the linear model idea for this as a Generalized Linear Model (GLM)<sup>[1]</sup> , by fitting our model via a ‘link function.’ This function transforms data and allows our response, and it’s variance, to relate to a linear model through the link function:</p>
<p><span class="math display">\[\large{g(\mu)= \alpha + \beta x}\]</span> Where <span class="math inline">\(\mu\)</span> is the expectation of Y, and <span class="math inline">\(g\)</span> is the link function</p>
<p><br></p>
<p>The Ordinary Least Squares (OLS) fitting technique used in linear regression, is not a good fit here as our data are not necessarily distributed like that. Here we can use ‘maximum-likelihood estimation’ (MLE). MLE is related to probability and can be used to identify the parameters that were most likely to have produced our data (the largest likelihood value, or ‘maximum likelihood’).</p>
<p>MLE is an iterative process, and is actually performed on the log-likelihood. The model is iteratively refitted to maximise the log-likelihood. Our model is said to ‘converge’ when we can’t improve it any more (usually changes in the log-likelihood &lt; 1e-8). <strong>If you get convergence-related error messages, it means the modelling function can’t settle on, or reach the MLE. This often means your parameterisation is mismatched, or there correlations in your data.</strong></p>
<p><br></p>
<p>Although many of the methods for <code>lm</code> are common to <code>glm</code>, inspecting plots of residuals is trickier. We also can’t use R<sup>2</sup> either, as the assumptions refect OLS. Various methods other methods exist, depend on what you want to compare, including:</p>
<ul>
<li>
<b>AUC:</b> For binary (or other multiple categorical models), the ‘area under the receiver operator characteristic curve’ (‘AUC’, ‘ROC’ or ‘C-statistic’) can be used and interpreted like R<sup>2</sup>, as the proportion of variation in <span class="math inline">\(y\)</span> explained by our model.</li>
<li>
<b>Likelihood Ratio test (LRT):</b> Two <code>glm</code>s can be compared using likelihood ratio tests, that compare the log-likelihoods between two models. We test a reduced model against the larger model, with the null hypothesis that the two likelihoods are not significantly different. If our test is positive (usually p&lt;0.05, but beware of p-values…), our models are signficantly different, with the one with higher log-likelihood the better model.</li>
<li>
<b>Akaike Information Criterion (AIC) <sup>[2]</sup>:</b> is a measure of relative information loss. The value cannot be directly interpreted, but can be compared between models, with lower AICs suggesting less information loss, and being ‘better’ models.</li>
<li>
<b>Prediction error:</b> If your model is primarily about prediction, and less about explanation<sup>[3]</sup>, measures of fit such as Mean-Square Error of Mean Absolute error can be helpful measures of predictive accuracy.</li>
</ul>
</div>
<div id="generalized-linear-models" class="section level2">
<h2 class="hasAnchor">
<a href="#generalized-linear-models" class="anchor"></a>Generalized Linear Models</h2>
<p>Let’s fit a generalized linear model, firstly for <code>Death</code>, and secondly for <code>LOS</code>.</p>
<div id="modelling-death" class="section level3">
<h3 class="hasAnchor">
<a href="#modelling-death" class="anchor"></a>Modelling death:</h3>
<p><code>Death</code> is a binary variable recorded in our <code>LOS_model</code> dataset. This cannot be linear and is usually modelled using the <code>binomial</code> family argument, and the <code>logit</code> link function. This link function is the default in <code>R</code> for <code>binomial</code> regressions, and is commonly referred to as <strong>Logistic Regression</strong>. We’ll fit this using the <code>glm</code> function. Rather than fitting <code>Death</code> as such, the link function makes this the log-odds of death.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">glm_binomial &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(Death <span class="op">~</span><span class="st"> </span>Age <span class="op">+</span><span class="st"> </span>LOS, <span class="dt">data=</span>LOS_model, <span class="dt">family=</span><span class="st">"binomial"</span>)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(glm_binomial)</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="co">#&gt; glm(formula = Death ~ Age + LOS, family = "binomial", data = LOS_model)</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="co">#&gt; Deviance Residuals: </span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="co">#&gt;     Min       1Q   Median       3Q      Max  </span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="co">#&gt; -1.1007  -0.6407  -0.5118  -0.4499   2.1803  </span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13"><span class="co">#&gt;              Estimate Std. Error z value Pr(&gt;|z|)    </span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14"><span class="co">#&gt; (Intercept) -2.435539   0.370818  -6.568  5.1e-11 ***</span></a>
<a class="sourceLine" id="cb4-15" data-line-number="15"><span class="co">#&gt; Age          0.003602   0.006372   0.565   0.5719    </span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16"><span class="co">#&gt; LOS          0.127344   0.044359   2.871   0.0041 ** </span></a>
<a class="sourceLine" id="cb4-17" data-line-number="17"><span class="co">#&gt; ---</span></a>
<a class="sourceLine" id="cb4-18" data-line-number="18"><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></a>
<a class="sourceLine" id="cb4-19" data-line-number="19"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb4-20" data-line-number="20"><span class="co">#&gt; (Dispersion parameter for binomial family taken to be 1)</span></a>
<a class="sourceLine" id="cb4-21" data-line-number="21"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb4-22" data-line-number="22"><span class="co">#&gt;     Null deviance: 279.78  on 299  degrees of freedom</span></a>
<a class="sourceLine" id="cb4-23" data-line-number="23"><span class="co">#&gt; Residual deviance: 267.06  on 297  degrees of freedom</span></a>
<a class="sourceLine" id="cb4-24" data-line-number="24"><span class="co">#&gt; AIC: 273.06</span></a>
<a class="sourceLine" id="cb4-25" data-line-number="25"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb4-26" data-line-number="26"><span class="co">#&gt; Number of Fisher Scoring iterations: 4</span></a>
<a class="sourceLine" id="cb4-27" data-line-number="27"></a>
<a class="sourceLine" id="cb4-28" data-line-number="28">ModelMetrics<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/ModelMetrics/man/auc.html">auc</a></span>(glm_binomial)</a>
<a class="sourceLine" id="cb4-29" data-line-number="29"><span class="co">#&gt; [1] 0.6594225</span></a></code></pre></div>
<p>Using the <code>summary</code> function, we can see our model output, including:</p>
<ul>
<li>The ‘call’, of model formula</li>
<li>A description of the distribution of the deviance residuals (don’t worry about this for now).</li>
<li>The ‘coefficients’, the estimates of the effects of our predictors, including their standard errors, and z-tests for their ‘significance.’ There is a legend, using <code><a href="https://rdrr.io/r/base/Arithmetic.html">*</a></code>, to indicate the significance levels.</li>
<li>Information on fit statistics</li>
<li>We also used the <code>ModelMetrics</code> package to calculate the <code>auc</code>. This is suggests that ~66% of the variation in our data can be explained by our model.</li>
</ul>
<p>If we consider the logic of the model above, it is telling us that LOS is a significant predictor for the log-odds of death, but that age is not. This seems unlikely, unless Age and LOS are not independent. If this is the case, e.g. elderly patients stay longer or that shorter staying elderly patients are more likely to have died, the effects of LOS may be obscuring the effects of Age. This is referred to as confounding. We can examine this using an <strong>interaction</strong> term.</p>
</div>
<div id="interactions" class="section level3">
<h3 class="hasAnchor">
<a href="#interactions" class="anchor"></a>Interactions</h3>
<p>‘Interactions’ are where predictor variables affect each other. For example, the Hospital Standardised Mortality Ratio (HSMR) <sup>[4]</sup> uses an interaction term between co-morbidity and age. So co-morbidities score may have different effects related to age, as well as the independent effects of age and co-morbidity score.</p>
<p>We can add these to our models with <code><a href="https://rdrr.io/r/base/Arithmetic.html">*</a></code> to include the interaction and the independent terms, or <code>:</code> if you just want the interaction without the independent terms:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">glm_binomial2&lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(Death <span class="op">~</span><span class="st"> </span>Age <span class="op">+</span><span class="st"> </span>LOS <span class="op">+</span><span class="st"> </span>Age<span class="op">*</span>LOS, <span class="dt">data=</span>LOS_model, <span class="dt">family=</span><span class="st">"binomial"</span>)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(glm_binomial2)</a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="co">#&gt; glm(formula = Death ~ Age + LOS + Age * LOS, family = "binomial", </span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="co">#&gt;     data = LOS_model)</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb5-9" data-line-number="9"><span class="co">#&gt; Deviance Residuals: </span></a>
<a class="sourceLine" id="cb5-10" data-line-number="10"><span class="co">#&gt;     Min       1Q   Median       3Q      Max  </span></a>
<a class="sourceLine" id="cb5-11" data-line-number="11"><span class="co">#&gt; -1.0115  -0.7134  -0.5092  -0.2699   2.7244  </span></a>
<a class="sourceLine" id="cb5-12" data-line-number="12"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb5-13" data-line-number="13"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb5-14" data-line-number="14"><span class="co">#&gt;              Estimate Std. Error z value Pr(&gt;|z|)    </span></a>
<a class="sourceLine" id="cb5-15" data-line-number="15"><span class="co">#&gt; (Intercept) -4.516296   0.747036  -6.046 1.49e-09 ***</span></a>
<a class="sourceLine" id="cb5-16" data-line-number="16"><span class="co">#&gt; Age          0.042619   0.011875   3.589 0.000332 ***</span></a>
<a class="sourceLine" id="cb5-17" data-line-number="17"><span class="co">#&gt; LOS          0.544862   0.135868   4.010 6.07e-05 ***</span></a>
<a class="sourceLine" id="cb5-18" data-line-number="18"><span class="co">#&gt; Age:LOS     -0.006988   0.001918  -3.643 0.000269 ***</span></a>
<a class="sourceLine" id="cb5-19" data-line-number="19"><span class="co">#&gt; ---</span></a>
<a class="sourceLine" id="cb5-20" data-line-number="20"><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></a>
<a class="sourceLine" id="cb5-21" data-line-number="21"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb5-22" data-line-number="22"><span class="co">#&gt; (Dispersion parameter for binomial family taken to be 1)</span></a>
<a class="sourceLine" id="cb5-23" data-line-number="23"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb5-24" data-line-number="24"><span class="co">#&gt;     Null deviance: 279.78  on 299  degrees of freedom</span></a>
<a class="sourceLine" id="cb5-25" data-line-number="25"><span class="co">#&gt; Residual deviance: 247.94  on 296  degrees of freedom</span></a>
<a class="sourceLine" id="cb5-26" data-line-number="26"><span class="co">#&gt; AIC: 255.94</span></a>
<a class="sourceLine" id="cb5-27" data-line-number="27"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb5-28" data-line-number="28"><span class="co">#&gt; Number of Fisher Scoring iterations: 5</span></a>
<a class="sourceLine" id="cb5-29" data-line-number="29"></a>
<a class="sourceLine" id="cb5-30" data-line-number="30">ModelMetrics<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/ModelMetrics/man/auc.html">auc</a></span>(glm_binomial2)</a>
<a class="sourceLine" id="cb5-31" data-line-number="31"><span class="co">#&gt; [1] 0.7068597</span></a></code></pre></div>
<p>Now our model is suggesting that Age, LOS and their interaction are significant. This suggests that, as well as their own effects, their combination is important, and their effects confound each other.</p>
</div>
</div>
<div id="prediction" class="section level2">
<h2 class="hasAnchor">
<a href="#prediction" class="anchor"></a>Prediction</h2>
<p>Now we have built a model, we can use it to predict our expected <span class="math inline">\(y\)</span>, the probability of death per patient in this case. We can supply a new dataset to fit it to, using <code>newdata</code>, or omitting this fits our model to the original dataset. Using a <code>glm</code>, we have built a model via a link function, so we need to decide what scale to make our predictions on: the <code>link</code> scale (the log-odds of death in this case) or the <code>response</code> (the probability of death in this case).</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">LOS_model<span class="op">$</span>preds &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(glm_binomial2, <span class="dt">type=</span><span class="st">"response"</span>)</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(LOS_model,<span class="dv">5</span>)</a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="co">#&gt;   ID Organisation Age LOS Death      preds</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="co">#&gt; 1  1       Trust1  55   2     0 0.13572744</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="co">#&gt; 2  2       Trust2  27   1     0 0.04700276</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="co">#&gt; 3  3       Trust3  93  12     0 0.14023994</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8"><span class="co">#&gt; 4  4       Trust4  45   3     1 0.12928742</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9"><span class="co">#&gt; 5  5       Trust5  70  11     0 0.28486502</span></a></code></pre></div>
<p>We have added our predictions back into the original <code>data.frame</code> using the column name <code>preds</code>, and patient ID 1 has a risk of death of 0.136 or 13.6% probability of death. These predictions can be used in many different applications, but common uses of them are identifying the highest risk patients for clinical audit, comparing ratios of the observed deaths and expected deaths (sum of the probability), or risk-adjusted control chart monitoring.</p>
</div>
<div id="length-of-stay-los" class="section level2">
<h2 class="hasAnchor">
<a href="#length-of-stay-los" class="anchor"></a>Length of Stay (LOS)</h2>
<p>LOS, the time a patient is in hospital, is another variable to examine in the dataset. This is a count, and is therefore bounded at zero (can’t have counts &lt; 0), can only take integer values (e.g. 2 or 3, but not 2.5) and is heavily right-skewed, as most patient are only admitted for one or two days, but rarely patients are in for much longer. We’ll apply a similar modelling approach to the last example, but the <code>family</code> argument and link function must be different. We will use the <code>Poisson</code> distribution and the natural logarithm link function, the standard choices for count data<sup>[5]</sup>.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">glm_poisson &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(LOS <span class="op">~</span><span class="st"> </span>Age <span class="op">*</span><span class="st"> </span>Death, <span class="dt">data=</span>LOS_model, <span class="dt">family=</span><span class="st">"poisson"</span> )</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(glm_poisson)</a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="co">#&gt; glm(formula = LOS ~ Age * Death, family = "poisson", data = LOS_model)</span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="co">#&gt; Deviance Residuals: </span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10"><span class="co">#&gt;     Min       1Q   Median       3Q      Max  </span></a>
<a class="sourceLine" id="cb7-11" data-line-number="11"><span class="co">#&gt; -3.4929  -0.9039  -0.1069   0.7589   3.3681  </span></a>
<a class="sourceLine" id="cb7-12" data-line-number="12"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-13" data-line-number="13"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb7-14" data-line-number="14"><span class="co">#&gt;              Estimate Std. Error z value Pr(&gt;|z|)    </span></a>
<a class="sourceLine" id="cb7-15" data-line-number="15"><span class="co">#&gt; (Intercept)  0.514456   0.078345   6.567 5.15e-11 ***</span></a>
<a class="sourceLine" id="cb7-16" data-line-number="16"><span class="co">#&gt; Age          0.018097   0.001169  15.479  &lt; 2e-16 ***</span></a>
<a class="sourceLine" id="cb7-17" data-line-number="17"><span class="co">#&gt; Death        1.491162   0.140864  10.586  &lt; 2e-16 ***</span></a>
<a class="sourceLine" id="cb7-18" data-line-number="18"><span class="co">#&gt; Age:Death   -0.020209   0.002187  -9.240  &lt; 2e-16 ***</span></a>
<a class="sourceLine" id="cb7-19" data-line-number="19"><span class="co">#&gt; ---</span></a>
<a class="sourceLine" id="cb7-20" data-line-number="20"><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></a>
<a class="sourceLine" id="cb7-21" data-line-number="21"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-22" data-line-number="22"><span class="co">#&gt; (Dispersion parameter for poisson family taken to be 1)</span></a>
<a class="sourceLine" id="cb7-23" data-line-number="23"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-24" data-line-number="24"><span class="co">#&gt;     Null deviance: 752.23  on 299  degrees of freedom</span></a>
<a class="sourceLine" id="cb7-25" data-line-number="25"><span class="co">#&gt; Residual deviance: 459.77  on 296  degrees of freedom</span></a>
<a class="sourceLine" id="cb7-26" data-line-number="26"><span class="co">#&gt; AIC: 1429</span></a>
<a class="sourceLine" id="cb7-27" data-line-number="27"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-28" data-line-number="28"><span class="co">#&gt; Number of Fisher Scoring iterations: 5</span></a></code></pre></div>
<p>We can’t use the <code>AUC</code> value here, as that is related to categories. We can only make comparisons between models or in terms of prediction error. Lets fit the same model without the interaction and see if it is different using the <code>AIC</code> or the likelihood ratio test (that tell you the same thing):</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">glm_poisson2 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(LOS <span class="op">~</span><span class="st"> </span>Age <span class="op">+</span><span class="st"> </span>Death, <span class="dt">data=</span>LOS_model, <span class="dt">family=</span><span class="st">"poisson"</span> )</a>
<a class="sourceLine" id="cb8-3" data-line-number="3"></a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/r/stats/AIC.html">AIC</a></span>(glm_poisson)</a>
<a class="sourceLine" id="cb8-5" data-line-number="5"><span class="co">#&gt; [1] 1428.967</span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="kw"><a href="https://rdrr.io/r/stats/AIC.html">AIC</a></span>(glm_poisson2)</a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="co">#&gt; [1] 1508.352</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8"></a>
<a class="sourceLine" id="cb8-9" data-line-number="9"><span class="co"># anova(glm_poisson2, glm_poisson, test="Chisq")  will do the same thing without using the lmtest package</span></a>
<a class="sourceLine" id="cb8-10" data-line-number="10">lmtest<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/lmtest/man/lrtest.html">lrtest</a></span>(glm_poisson, glm_poisson2)</a>
<a class="sourceLine" id="cb8-11" data-line-number="11"><span class="co">#&gt; Likelihood ratio test</span></a>
<a class="sourceLine" id="cb8-12" data-line-number="12"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb8-13" data-line-number="13"><span class="co">#&gt; Model 1: LOS ~ Age * Death</span></a>
<a class="sourceLine" id="cb8-14" data-line-number="14"><span class="co">#&gt; Model 2: LOS ~ Age + Death</span></a>
<a class="sourceLine" id="cb8-15" data-line-number="15"><span class="co">#&gt;   #Df  LogLik Df  Chisq Pr(&gt;Chisq)    </span></a>
<a class="sourceLine" id="cb8-16" data-line-number="16"><span class="co">#&gt; 1   4 -710.48                         </span></a>
<a class="sourceLine" id="cb8-17" data-line-number="17"><span class="co">#&gt; 2   3 -751.18 -1 81.385  &lt; 2.2e-16 ***</span></a>
<a class="sourceLine" id="cb8-18" data-line-number="18"><span class="co">#&gt; ---</span></a>
<a class="sourceLine" id="cb8-19" data-line-number="19"><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></a></code></pre></div>
<p>Our <code>AIC</code> is lower for the interaction model, and the likelihood ratio test suggest the reduced model is significantly worse.</p>
<div id="overdispersion" class="section level3">
<h3 class="hasAnchor">
<a href="#overdispersion" class="anchor"></a>Overdispersion</h3>
<p>One of the downfalls of a Poisson models that it’s variance is fixed. This is always proportional to the conditional mean. I will spare you the maths at this point, but what it means is that the variance doesn’t scale to the data. This would be fine if our data were perfectly Poisson distributed, but that is rare in practice. Data commonly display more variance than we would expect, and this is referred to as <strong><em>overdispersion</em></strong> (OD). OD causes us to underestimate the variance in our model, and our assessments of the significance of parameters are too optimistic because our error is too small. It also affects overall assessment of model fit.</p>
<p>We can test for this, by comparing the ratio of the sum of the squared Pearson residuals over the degrees of freedom. If this value is 1, then the variance is as expected (‘equidispersion’), but if it is &gt;1, then we have OD.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"> <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(glm_poisson,<span class="dt">type=</span><span class="st">"pearson"</span>) <span class="op">^</span><span class="dv">2</span>)<span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/df.residual.html">df.residual</a></span>(glm_poisson)</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="co">#&gt; [1] 1.464411</span></a></code></pre></div>
<p><strong>Our model is overdispersed, with residual variance around 1.4 times what the Poisson distribution expects.</strong></p>
<p><br></p>
<p>There are various different ways to deal with this, and this vignette demonstrates three of the following list. Our options include:</p>
<ul>
<li>
<strong>Ignoring it:</strong> the Poisson is an <code>unbiased</code> model, so if we only care about our estimates, or predicted values (and not the error, or ‘significance’) we might do this.</li>
<li>
<strong>Manually scaling our variance:</strong> we can do this using our dispersion ratio</li>
<li>
<strong>Quasi-likelihood models:</strong> these do not use a full MLE process, using estimating equations instead. These models allow for scaling of the error, but with no MLE we can’t use AIC or likelihood ratio tests.</li>
<li>Variance structures (this is a huge topic, but we’ll pick one). Regression assumes all data points are independent and uncorrelated. If this is not the case in our data, we need to consider this in our models. We have repeated measurements from 10 Trusts in this dataset. It likely that LOS, and demographics like age, are at least partly related to which Trust the data come from. This is referred to as <strong><em>clustering</em></strong>, and it introduces correlations in the data. There are ways to explicit model this correlation, including:
<ul>
<li>
<strong>Mixture models:</strong> using more than one distribution to model the data. Negative Binomial family uses two distributions, for between and within unit variances. The NB2<sup>[5]</sup> parametrisation assumes a Poisson distribution within units and a gamma distribution between.</li>
<li>
<strong>Random-Intercept Model</strong>: GLMs can be further updated to allow for variance structures, using a Generalised Linear Mixed Model (GLMM), or Multi-level model<sup>[6]</sup>. The variance structures are referred to as ‘random effects’ and fix the parameter estimate at 0, but allow the variance to be estimated. Our model coefficients we reported in the GLM’s earlier are referred to as ‘fixed effects’ to distinguish between the two. In our case, a random-intercept at Trust-level is appropriate.</li>
</ul>
</li>
</ul>
<p>So lets try some of them out. To fit a quasi-Poisson model, we simply change the family. Note the dispersion parameter matches the calculation above:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">quasi&lt;-<span class="kw"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(LOS <span class="op">~</span><span class="st"> </span>Age <span class="op">*</span><span class="st"> </span>Death, <span class="dt">data=</span>LOS_model, <span class="dt">family=</span><span class="st">"quasipoisson"</span> )</a>
<a class="sourceLine" id="cb10-2" data-line-number="2"></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(quasi)</a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="co">#&gt; glm(formula = LOS ~ Age * Death, family = "quasipoisson", data = LOS_model)</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8"><span class="co">#&gt; Deviance Residuals: </span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9"><span class="co">#&gt;     Min       1Q   Median       3Q      Max  </span></a>
<a class="sourceLine" id="cb10-10" data-line-number="10"><span class="co">#&gt; -3.4929  -0.9039  -0.1069   0.7589   3.3681  </span></a>
<a class="sourceLine" id="cb10-11" data-line-number="11"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb10-12" data-line-number="12"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13"><span class="co">#&gt;              Estimate Std. Error t value Pr(&gt;|t|)    </span></a>
<a class="sourceLine" id="cb10-14" data-line-number="14"><span class="co">#&gt; (Intercept)  0.514456   0.094807   5.426 1.20e-07 ***</span></a>
<a class="sourceLine" id="cb10-15" data-line-number="15"><span class="co">#&gt; Age          0.018097   0.001415  12.791  &lt; 2e-16 ***</span></a>
<a class="sourceLine" id="cb10-16" data-line-number="16"><span class="co">#&gt; Death        1.491162   0.170463   8.748  &lt; 2e-16 ***</span></a>
<a class="sourceLine" id="cb10-17" data-line-number="17"><span class="co">#&gt; Age:Death   -0.020209   0.002647  -7.636 3.12e-13 ***</span></a>
<a class="sourceLine" id="cb10-18" data-line-number="18"><span class="co">#&gt; ---</span></a>
<a class="sourceLine" id="cb10-19" data-line-number="19"><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></a>
<a class="sourceLine" id="cb10-20" data-line-number="20"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb10-21" data-line-number="21"><span class="co">#&gt; (Dispersion parameter for quasipoisson family taken to be 1.464411)</span></a>
<a class="sourceLine" id="cb10-22" data-line-number="22"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb10-23" data-line-number="23"><span class="co">#&gt;     Null deviance: 752.23  on 299  degrees of freedom</span></a>
<a class="sourceLine" id="cb10-24" data-line-number="24"><span class="co">#&gt; Residual deviance: 459.77  on 296  degrees of freedom</span></a>
<a class="sourceLine" id="cb10-25" data-line-number="25"><span class="co">#&gt; AIC: NA</span></a>
<a class="sourceLine" id="cb10-26" data-line-number="26"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb10-27" data-line-number="27"><span class="co">#&gt; Number of Fisher Scoring iterations: 5</span></a></code></pre></div>
<p>For a negative binomial model, two options are <code>glm.nb</code> from the <code>MASS</code> package, or <code>glmmTMB</code> function from the package of the same name. Note that the function from <code>MASS</code> does not take a <code>family</code> argument. The dispersion factor here is quadratic to the mean, so don’t compare it directly to the scale factor above.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(MASS)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"></a>
<a class="sourceLine" id="cb11-3" data-line-number="3">nb &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/MASS/man/glm.nb.html">glm.nb</a></span>(LOS <span class="op">~</span><span class="st"> </span>Age <span class="op">*</span><span class="st"> </span>Death, <span class="dt">data=</span>LOS_model,)</a>
<a class="sourceLine" id="cb11-4" data-line-number="4"></a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(nb)</a>
<a class="sourceLine" id="cb11-6" data-line-number="6"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb11-7" data-line-number="7"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb11-8" data-line-number="8"><span class="co">#&gt; glm.nb(formula = LOS ~ Age * Death, data = LOS_model, init.theta = 8.300914044, </span></a>
<a class="sourceLine" id="cb11-9" data-line-number="9"><span class="co">#&gt;     link = log)</span></a>
<a class="sourceLine" id="cb11-10" data-line-number="10"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb11-11" data-line-number="11"><span class="co">#&gt; Deviance Residuals: </span></a>
<a class="sourceLine" id="cb11-12" data-line-number="12"><span class="co">#&gt;     Min       1Q   Median       3Q      Max  </span></a>
<a class="sourceLine" id="cb11-13" data-line-number="13"><span class="co">#&gt; -2.7320  -0.7464  -0.0903   0.6332   2.2742  </span></a>
<a class="sourceLine" id="cb11-14" data-line-number="14"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb11-15" data-line-number="15"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb11-16" data-line-number="16"><span class="co">#&gt;              Estimate Std. Error z value Pr(&gt;|z|)    </span></a>
<a class="sourceLine" id="cb11-17" data-line-number="17"><span class="co">#&gt; (Intercept)  0.509047   0.091934   5.537 3.08e-08 ***</span></a>
<a class="sourceLine" id="cb11-18" data-line-number="18"><span class="co">#&gt; Age          0.018194   0.001448  12.565  &lt; 2e-16 ***</span></a>
<a class="sourceLine" id="cb11-19" data-line-number="19"><span class="co">#&gt; Death        1.494414   0.183974   8.123 4.55e-16 ***</span></a>
<a class="sourceLine" id="cb11-20" data-line-number="20"><span class="co">#&gt; Age:Death   -0.020269   0.002881  -7.035 2.00e-12 ***</span></a>
<a class="sourceLine" id="cb11-21" data-line-number="21"><span class="co">#&gt; ---</span></a>
<a class="sourceLine" id="cb11-22" data-line-number="22"><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></a>
<a class="sourceLine" id="cb11-23" data-line-number="23"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb11-24" data-line-number="24"><span class="co">#&gt; (Dispersion parameter for Negative Binomial(8.3009) family taken to be 1)</span></a>
<a class="sourceLine" id="cb11-25" data-line-number="25"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb11-26" data-line-number="26"><span class="co">#&gt;     Null deviance: 473.82  on 299  degrees of freedom</span></a>
<a class="sourceLine" id="cb11-27" data-line-number="27"><span class="co">#&gt; Residual deviance: 285.44  on 296  degrees of freedom</span></a>
<a class="sourceLine" id="cb11-28" data-line-number="28"><span class="co">#&gt; AIC: 1388.5</span></a>
<a class="sourceLine" id="cb11-29" data-line-number="29"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb11-30" data-line-number="30"><span class="co">#&gt; Number of Fisher Scoring iterations: 1</span></a>
<a class="sourceLine" id="cb11-31" data-line-number="31"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb11-32" data-line-number="32"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb11-33" data-line-number="33"><span class="co">#&gt;               Theta:  8.30 </span></a>
<a class="sourceLine" id="cb11-34" data-line-number="34"><span class="co">#&gt;           Std. Err.:  1.82 </span></a>
<a class="sourceLine" id="cb11-35" data-line-number="35"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb11-36" data-line-number="36"><span class="co">#&gt;  2 x log-likelihood:  -1378.487</span></a></code></pre></div>
<p>Finally, using the random-intercept model, fitted with <code>glmer</code> from the <code>lme4</code> package. The extra formula argument specifies the random-intercept, where 1 means the intercept, and the <code><a href="https://rdrr.io/r/base/Logic.html">|</a></code> reads as ‘intercept varying by organisation.’</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(lme4)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="co">#&gt; Loading required package: Matrix</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"></a>
<a class="sourceLine" id="cb12-4" data-line-number="4">glmm &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/lme4/man/glmer.html">glmer</a></span>(LOS <span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/scale.html">scale</a></span>(Age) <span class="op">*</span><span class="st"> </span>Death <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span><span class="op">|</span>Organisation), <span class="dt">data=</span>LOS_model, <span class="dt">family=</span><span class="st">"poisson"</span>)</a>
<a class="sourceLine" id="cb12-5" data-line-number="5"></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(glmm)</a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="co">#&gt; Generalized linear mixed model fit by maximum likelihood (Laplace</span></a>
<a class="sourceLine" id="cb12-8" data-line-number="8"><span class="co">#&gt;   Approximation) [glmerMod]</span></a>
<a class="sourceLine" id="cb12-9" data-line-number="9"><span class="co">#&gt;  Family: poisson  ( log )</span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10"><span class="co">#&gt; Formula: LOS ~ scale(Age) * Death + (1 | Organisation)</span></a>
<a class="sourceLine" id="cb12-11" data-line-number="11"><span class="co">#&gt;    Data: LOS_model</span></a>
<a class="sourceLine" id="cb12-12" data-line-number="12"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb12-13" data-line-number="13"><span class="co">#&gt;      AIC      BIC   logLik deviance df.resid </span></a>
<a class="sourceLine" id="cb12-14" data-line-number="14"><span class="co">#&gt;   1429.7   1448.2   -709.9   1419.7      295 </span></a>
<a class="sourceLine" id="cb12-15" data-line-number="15"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb12-16" data-line-number="16"><span class="co">#&gt; Scaled residuals: </span></a>
<a class="sourceLine" id="cb12-17" data-line-number="17"><span class="co">#&gt;     Min      1Q  Median      3Q     Max </span></a>
<a class="sourceLine" id="cb12-18" data-line-number="18"><span class="co">#&gt; -2.6962 -0.8040 -0.0905  0.8521  4.2508 </span></a>
<a class="sourceLine" id="cb12-19" data-line-number="19"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb12-20" data-line-number="20"><span class="co">#&gt; Random effects:</span></a>
<a class="sourceLine" id="cb12-21" data-line-number="21"><span class="co">#&gt;  Groups       Name        Variance Std.Dev.</span></a>
<a class="sourceLine" id="cb12-22" data-line-number="22"><span class="co">#&gt;  Organisation (Intercept) 0.00396  0.06293 </span></a>
<a class="sourceLine" id="cb12-23" data-line-number="23"><span class="co">#&gt; Number of obs: 300, groups:  Organisation, 10</span></a>
<a class="sourceLine" id="cb12-24" data-line-number="24"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb12-25" data-line-number="25"><span class="co">#&gt; Fixed effects:</span></a>
<a class="sourceLine" id="cb12-26" data-line-number="26"><span class="co">#&gt;                  Estimate Std. Error z value Pr(&gt;|z|)    </span></a>
<a class="sourceLine" id="cb12-27" data-line-number="27"><span class="co">#&gt; (Intercept)       1.43006    0.03818  37.455  &lt; 2e-16 ***</span></a>
<a class="sourceLine" id="cb12-28" data-line-number="28"><span class="co">#&gt; scale(Age)        0.50621    0.03263  15.513  &lt; 2e-16 ***</span></a>
<a class="sourceLine" id="cb12-29" data-line-number="29"><span class="co">#&gt; Death             0.46200    0.06391   7.229 4.87e-13 ***</span></a>
<a class="sourceLine" id="cb12-30" data-line-number="30"><span class="co">#&gt; scale(Age):Death -0.56021    0.06116  -9.159  &lt; 2e-16 ***</span></a>
<a class="sourceLine" id="cb12-31" data-line-number="31"><span class="co">#&gt; ---</span></a>
<a class="sourceLine" id="cb12-32" data-line-number="32"><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></a>
<a class="sourceLine" id="cb12-33" data-line-number="33"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb12-34" data-line-number="34"><span class="co">#&gt; Correlation of Fixed Effects:</span></a>
<a class="sourceLine" id="cb12-35" data-line-number="35"><span class="co">#&gt;             (Intr) scl(A) Death </span></a>
<a class="sourceLine" id="cb12-36" data-line-number="36"><span class="co">#&gt; scale(Age)  -0.348              </span></a>
<a class="sourceLine" id="cb12-37" data-line-number="37"><span class="co">#&gt; Death       -0.433  0.204       </span></a>
<a class="sourceLine" id="cb12-38" data-line-number="38"><span class="co">#&gt; scl(Ag):Dth  0.183 -0.529 -0.253</span></a></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/stats/confint.html">confint</a></span>(glmm)</a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="co">#&gt; Computing profile confidence intervals ...</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="co">#&gt;                       2.5 %     97.5 %</span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="co">#&gt; .sig01            0.0000000  0.1511114</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="co">#&gt; (Intercept)       1.3494494  1.5079597</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6"><span class="co">#&gt; scale(Age)        0.4426231  0.5705900</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7"><span class="co">#&gt; Death             0.3353796  0.5860630</span></a>
<a class="sourceLine" id="cb13-8" data-line-number="8"><span class="co">#&gt; scale(Age):Death -0.6797591 -0.4398526</span></a></code></pre></div>
<p>These models are significantly more complicated. <code>Confint</code> can be use to calculate the confidence intervals above by profiling the likelihood (provided you have the <code>MASS</code> package installed). This allow you to assess the significance of the random-effects. Our CI butts up to zero here, and the AIC is slightly worse than the <code>glm</code>. This suggests it is not well-modelled with the normally distributed random-intercept. The NB model appears to perform better.</p>
<p>Predictions from GLMMS also requires more thought. You can predict with (“conditional”) or without (“marginal”) the random effects. Conditional predictions will have the adjustment for their cluster (or whatever random effect you have fitted), but marginal could be considered the model average, subject to the fixed effects, removing the effects of cluster.</p>
</div>
</div>
<div id="summary" class="section level2">
<h2 class="hasAnchor">
<a href="#summary" class="anchor"></a>Summary</h2>
<p>The <code>LOS_model</code> dataset is a fabricated patient dataset with Age, Length of Stay and Death status for 300 patients across 10 hospitals (‘Trusts’). It can be used to learn GLM, GLMM and other related modelling techniques, with examples above.</p>
<hr>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<ol style="list-style-type: decimal">
<li><p>NELDER, J. A. &amp; WEDDERBURN, R. W. M. 1972. Generalized Linear Models. <em>Journal of the Royal Statistical Society. Series A (General)</em>, <strong>135</strong>, 370-384</p></li>
<li><p>AKAIKE, H. 1998. Information Theory and an Extension of the Maximum Likelihood Principle. In: PARZEN, E., TANABE, K. &amp; KITAGAWA, G. (eds.) <em>Selected Papers of Hirotugu Akaike</em>. New York, NY: Springer New York</p></li>
<li><p>SHMUELI, G. 2010. To Explain or to Predict? <em>Statist. Sci.</em> , <strong>25</strong>, 289-310.</p></li>
<li><p>JARMAN, B., GAULT, S., ALVES, B., HIDER, A., DOLAN, S., COOK, A., HURWITZ, B. &amp; IEZZONI, L. I. 1999. <em>Explaining differences in English hospital death rates using routinely collected data</em>. BMJ, <strong>318</strong>, 1515-1520</p></li>
<li><p>CAMERON, A. C. &amp; TRIVEDI, P. K. 2013. <em>Regression Analysis of Count Data</em>, Cambridge University Press</p></li>
<li><p>GOLDSTEIN, H. 2010. <em>Multilevel Statistical Models</em>, John Wiley &amp; Sons Inc.</p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#first-load-the-data-and-inspect-it">First, load the data and inspect it</a></li>
      <li><a href="#modelling-los-and-death">Modelling LOS and Death</a></li>
      <li><a href="#generalized-linear-models">Generalized Linear Models</a></li>
      <li><a href="#prediction">Prediction</a></li>
      <li><a href="#length-of-stay-los">Length of Stay (LOS)</a></li>
      <li><a href="#summary">Summary</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://www.mainard.co.uk">Chris Mainey</a>, Tom Jemmett.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
